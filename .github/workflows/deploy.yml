name: CI - Deploy chart to OpenShift (uses oc + namespace from values.yaml)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install oc (OpenShift client)
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz -C /tmp
          sudo mv /tmp/oc /usr/local/bin/oc
          sudo mv /tmp/kubectl /usr/local/bin/kubectl || true
          oc version

      - name: Login to OpenShift
        env:
          OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
          OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
          OPENSHIFT_INSECURE: ${{ secrets.OPENSHIFT_INSECURE }}
        run: |
          if [ -z "${OPENSHIFT_SERVER}" ] || [ -z "${OPENSHIFT_TOKEN}" ]; then
            echo "ERROR: OPENSHIFT_SERVER and OPENSHIFT_TOKEN secrets must be set"
            exit 1
          fi

          if [ "${OPENSHIFT_INSECURE:-false}" = "true" ]; then
            oc login "${OPENSHIFT_SERVER}" --token="${OPENSHIFT_TOKEN}" --insecure-skip-tls-verify=true
          else
            oc login "${OPENSHIFT_SERVER}" --token="${OPENSHIFT_TOKEN}"
          fi

      - name: Read namespace from chart values.yaml
        id: read_ns
        run: |
          # Buscar el primer values.yaml en el repo (ajusta -maxdepth si tu layout es m√°s profundo)
          VALUES_FILE=$(find . -maxdepth 3 -type f -name values.yaml | head -n1 || true)

          if [ -z "$VALUES_FILE" ]; then
            echo "WARNING: values.yaml not found in repo root or charts/; using default namespace"
            NAMESPACE="comments-namespace"
          else
            echo "Found values file: $VALUES_FILE"
            # Extraer la primera ocurrencia de 'namespace: <valor>' (ignora comentarios)
            NAMESPACE=$(grep -E '^[[:space:]]*namespace[[:space:]]*:' "$VALUES_FILE" | head -n1 | awk -F':' '{val=$2; sub(/^[ \t]+/,"",val); sub(/[ \t]+$/,"",val); print val}')
            # Quitar comillas si existen
            NAMESPACE=$(echo "$NAMESPACE" | sed -e 's/^"\(.*\)"$/\1/' -e "s/^'\(.*\)'$/\1/")
            if [ -z "$NAMESPACE" ]; then
              echo "No 'namespace:' key found in $VALUES_FILE; using default namespace"
              NAMESPACE="comments-namespace"
            fi
          fi

          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Ensure namespace and Docker Hub pull secret (using oc)
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          NAMESPACE="${{ steps.read_ns.outputs.namespace }}"
          echo "Using namespace: ${NAMESPACE}"
          oc create namespace "${NAMESPACE}" --dry-run=client -o yaml | oc apply -f -
          oc create secret docker-registry regcred \
            --docker-server=https://index.docker.io/v1/ \
            --docker-username="${DOCKERHUB_USERNAME}" \
            --docker-password="${DOCKERHUB_TOKEN}" \
            --dry-run=client -o yaml | oc -n "${NAMESPACE}" apply -f -
          oc -n "${NAMESPACE}" secrets link default regcred --for=pull || true

      - name: Set up Helm
        uses: azure/setup-helm@v3

      - name: Helm upgrade --install
        env:
          HELM_EXPERIMENTAL_OCI: 0
        run: |
          NAMESPACE="${{ steps.read_ns.outputs.namespace }}"
          helm upgrade --install comments-release ./ -n "${NAMESPACE}" --create-namespace \
            --set images.frontend.tag=${{ github.sha }} \
            --set images.backendApi.tag=${{ github.sha }} \
            --set images.backendData.tag=${{ github.sha }} \
            --set-string mongodb.password="${{ secrets.MONGO_PASSWORD }}" \
            --wait