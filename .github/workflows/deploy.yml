name: CI - Deploy chart to OpenShift (uses oc + inputs)

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Namespace to deploy'
        required: false
        default: ''
      frontend_tag:
        required: false
        default: ''
      backendapi_tag:
        required: false
        default: ''
      backenddata_tag:
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install oc (pinned)
        run: |
          OC_VERSION="4.14.0"
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/${OC_VERSION}/openshift-client-linux-${OC_VERSION}.tar.gz
          tar -xzf openshift-client-linux-${OC_VERSION}.tar.gz -C /tmp
          sudo mv /tmp/oc /usr/local/bin/oc
          sudo mv /tmp/kubectl /usr/local/bin/kubectl || true
          oc version

      - name: Login to OpenShift
        env:
          OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
          OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
          OPENSHIFT_INSECURE: ${{ secrets.OPENSHIFT_INSECURE }}
        run: |
          if [ -z "${OPENSHIFT_SERVER}" ] || [ -z "${OPENSHIFT_TOKEN}" ]; then
            echo "ERROR: OPENSHIFT_SERVER and OPENSHIFT_TOKEN secrets must be set"
            exit 1
          fi
          if [ "${OPENSHIFT_INSECURE:-false}" = "true" ]; then
            oc login "${OPENSHIFT_SERVER}" --token="${OPENSHIFT_TOKEN}" --insecure-skip-tls-verify=true
          else
            oc login "${OPENSHIFT_SERVER}" --token="${OPENSHIFT_TOKEN}"
          fi

      - name: Read namespace from chart values.yaml or use input
        id: read_ns
        run: |
          VALUES_FILE="values.yaml"
          DEFAULT_NS="comments-namespace"
          if [ -n "${{ github.event.inputs.namespace }}" ]; then
            NAMESPACE="${{ github.event.inputs.namespace }}"
          elif [ -f "$VALUES_FILE" ]; then
            NAMESPACE=$(grep -E '^[[:space:]]*namespace[[:space:]]*:' "$VALUES_FILE" | head -n1 | awk -F':' '{gsub(/^[ \t]+|[ \t]+$/,"",$2); print $2}')
            [ -z "$NAMESPACE" ] && NAMESPACE="$DEFAULT_NS"
          else
            NAMESPACE="$DEFAULT_NS"
          fi
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Ensure namespace and Docker Hub pull secret (using oc)
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          NAMESPACE="${{ steps.read_ns.outputs.namespace }}"
          oc create namespace ${NAMESPACE} --dry-run=client -o yaml | oc apply -f -
          oc create secret docker-registry regcred \
            --docker-server=https://index.docker.io/v1/ \
            --docker-username="${DOCKERHUB_USERNAME}" \
            --docker-password="${DOCKERHUB_TOKEN}" \
            --dry-run=client -o yaml | oc -n ${NAMESPACE} apply -f -
          oc -n ${NAMESPACE} secrets link default regcred --for=pull || true

      - name: Set up Helm
        uses: azure/setup-helm@v3

      - name: Helm upgrade --install
        env:
          HELM_EXPERIMENTAL_OCI: 0
        run: |
          NAMESPACE="${{ steps.read_ns.outputs.namespace }}"
          # Allow providing tags via workflow inputs; fallback to repo sha of this run
          FRONT_TAG="${{ github.event.inputs.frontend_tag || github.sha }}"
          API_TAG="${{ github.event.inputs.backendapi_tag || github.sha }}"
          DATA_TAG="${{ github.event.inputs.backenddata_tag || github.sha }}"
          helm upgrade --install comments-release ./ -n "${NAMESPACE}" --create-namespace \
            --set images.frontend.tag="${FRONT_TAG}" \
            --set images.backendApi.tag="${API_TAG}" \
            --set images.backendData.tag="${DATA_TAG}" \
            --set-string mongodb.password="${{ secrets.MONGO_PASSWORD }}" \
            --wait --timeout 10m --atomic